<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>OK Antalya / Mafia Academy</title><style>body{font-family:sans-serif;line-height:1.6;margin:20px;background-color:#f4f4f4}.container{max-width:1200px;margin:auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,.1)}h1,h2,h3{text-align:center;color:#333}.screen{display:none}.screen.active{display:block}.form-group{margin-bottom:15px}label{display:block;margin-bottom:5px;font-weight:700}input[type=number]{width:60px;padding:8px;border:1px solid #ccc;border-radius:4px}button{display:inline-block;background:#5cb85c;color:#fff;padding:10px 20px;border:none;border-radius:4px;cursor:pointer;font-size:16px;margin-top:10px}#night-action-form button{margin-right:12px}.skip-action{background:#ff9800;color:#fff}.skip-action:hover{background:#fb8c00}button:hover{background:#4cae4c}#role-selection label{display:inline-block;margin-right:15px}#role-selection input[type=checkbox]{margin-right:5px}#role-count-validation,#team-balance-validation{color:red;font-weight:700;margin-top:10px}#player-display{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px;margin-top:20px}.player-card{border:1px solid #ccc;padding:10px;border-radius:5px;background-color:#f9f9f9;text-align:center}.player-card.dead{opacity:.5;background-color:#ddd}.player-card .role{font-style:italic;color:#666}.player-card .team-red{color:red;font-weight:700}.player-card .team-black{color:#000;font-weight:700}.player-card .team-independent{color:#00f;font-weight:700}#timer-controls{margin-top:20px;text-align:center}#timer-display{font-size:2em;font-weight:700;margin-bottom:10px}#timer-controls button{margin:0 5px}#game-controls{margin-top:20px;text-align:center}#game-log{margin-top:30px;border-top:1px solid #eee;padding-top:20px}#log-list{list-style-type:none;padding:0;max-height:200px;overflow-y:auto;border:1px solid #eee;padding:10px}#log-list li{margin-bottom:5px;font-size:.9em;color:#555}</style></head><body><div class="container"><h1>OK Antalya / Mafia Academy 2025</h1><div id="setup-screen" class="screen active"><h2>Game Setup</h2><div class="form-group"><label for="player-count">Number of Players (5-20):</label> <input type="number" id="player-count" name="player-count" min="5" max="20" value="10"></div><div class="form-group"><h3>Role Configuration</h3><p>Mandatory Roles: Don, Komissar</p><div class="form-group"><label for="mafia-count">Number of Mafia:</label> <input type="number" id="mafia-count" name="mafia-count" min="1" value="1"></div><div id="role-selection"></div><p id="role-count-validation"></p><p id="team-balance-validation"></p></div><button id="proceed-to-assignment">Proceed to Role Assignment</button></div><div id="role-assignment-screen" class="screen"><h2>Role Assignment</h2><button id="start-game">Start Game</button></div><div id="game-screen" class="screen"><h2>Game In Progress</h2><div id="player-display"></div><div id="timer-controls"></div><div id="game-controls"></div><div id="game-log"><h3>Game Log</h3><ul id="log-list"></ul></div></div><div id="report-screen" class="screen"><h2>Night Report</h2><button id="next-day">Start Next Day</button></div></div><script>document.addEventListener("DOMContentLoaded",(()=>{const e={setup:document.getElementById("setup-screen"),roleAssignment:document.getElementById("role-assignment-screen"),game:document.getElementById("game-screen"),report:document.getElementById("report-screen")},t={playerCountInput:document.getElementById("player-count"),roleSelectionDiv:document.getElementById("role-selection"),roleCountValidation:document.getElementById("role-count-validation"),teamBalanceValidation:document.getElementById("team-balance-validation"),proceedToAssignmentButton:document.getElementById("proceed-to-assignment"),mafiaCountInput:document.getElementById("mafia-count")},n={don:{name:"Don",team:"Black",nightAction:!0,mandatory:!0},mafia:{name:"Mafia",team:"Black",nightAction:!0,mandatory:!1},komissar:{name:"Komissar",team:"Red",nightAction:!0,mandatory:!0},doctor:{name:"Doctor",team:"Red",nightAction:!0,mandatory:!1},krasotka:{name:"Krasotka",team:"Red",nightAction:!0,mandatory:!1},oboroten:{name:"Oboroten",team:"Red",nightAction:!0,mandatory:!1},zhurnalist:{name:"Zhurnalist",team:"Red",nightAction:!0,mandatory:!1},afferist:{name:"Afferist",team:"Red",nightAction:!1,mandatory:!1},citizen:{name:"Citizen",team:"Red",nightAction:!1,mandatory:!1},maniac:{name:"Maniac",team:"Independent",nightAction:!0,mandatory:!1}};let a={currentScreen:"setup",playerCount:10,selectedRoles:[],players:[],currentPhase:null,dayNumber:0,nominationOrder:[],manualMafiaCount:1,eliminatedByVoteToday:[],gameOver:!1};function o(t){a.currentScreen=t,Object.values(e).forEach((e=>e.classList.remove("active"))),e[t]?e[t].classList.add("active"):console.error(`Screen "${t}" not found.`)}function i(){a.playerCount=parseInt(t.playerCountInput.value,10),(isNaN(a.playerCount)||a.playerCount<5||a.playerCount>20)&&(a.playerCount=10,t.playerCountInput.value=a.playerCount);let e=1;a.playerCount>=7&&e++,a.playerCount>=11&&e++,a.playerCount>=16&&e++,t.mafiaCountInput.value=e,function(){t.roleSelectionDiv.innerHTML="";a.playerCount;Object.entries(n).filter((([e,t])=>!t.mandatory&&"mafia"!==e&&"citizen"!==e&&"zhurnalist"!==e&&"afferist"!==e)).forEach((([e,n])=>{const a=document.createElement("label"),o=document.createElement("input");o.type="checkbox",o.value=e,o.id=`role-${e}`,o.addEventListener("change",r),a.htmlFor=`role-${e}`,a.appendChild(o),a.appendChild(document.createTextNode(` ${n.name} (${n.team})`)),t.roleSelectionDiv.appendChild(a)})),r()}()}function r(){const e=t.roleSelectionDiv.querySelectorAll('input[type="checkbox"]:checked');a.selectedRoles=Array.from(e).map((e=>e.value));const o=a.playerCount;let i=2,r=0,l=parseInt(t.mafiaCountInput.value,10);const s=Math.max(1,o-a.selectedRoles.length-2);isNaN(l)||l<1?(l=1,t.mafiaCountInput.value=l):l>s&&(l=s,t.mafiaCountInput.value=l),a.manualMafiaCount=l,i+=l,i+=a.selectedRoles.length,r=o-i,t.roleCountValidation.textContent="",t.teamBalanceValidation.textContent="",t.proceedToAssignmentButton.disabled=!1,r<0?(t.roleCountValidation.textContent=`Too many roles selected (${i-l} optional + ${l} Mafia). Maximum is ${o-2}.`,t.proceedToAssignmentButton.disabled=!0):i>o?(t.roleCountValidation.textContent=`Selected roles (${i}) exceed player count (${o}).`,t.proceedToAssignmentButton.disabled=!0):t.roleCountValidation.textContent=`Selected: ${a.selectedRoles.length} optional roles + ${l} Mafia + ${r} Citizens + Don + Komissar = ${o} total.`;const c=l+(n.don.mandatory?1:0),d=r+(n.komissar.mandatory?1:0)+a.selectedRoles.filter((e=>"Red"===n[e].team)).length,m=a.selectedRoles.filter((e=>"Independent"===n[e].team)).length;t.proceedToAssignmentButton.disabled||(t.teamBalanceValidation.textContent=`Teams: Black: ${c}, Red: ${d}, Independent: ${m}`,2*c>=o&&(t.teamBalanceValidation.textContent+=" (Warning: Black team starts strong!)"))}function l(){t.proceedToAssignmentButton.disabled?alert("Please fix the role selection errors before proceeding."):(console.log("Proceeding to Role Assignment with:",a),console.log("Initializing Role Assignment Screen"),document.getElementById("start-game").addEventListener("click",m),s(),c(),o("roleAssignment"))}function s(){a.players=[];const e=a.playerCount;let t=["don","komissar"];const o=a.manualMafiaCount;for(let e=0;e<o;e++)t.push("mafia");t.push(...a.selectedRoles);const i=e-t.length;for(let e=0;e<i;e++)t.push("citizen");for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}for(let o=0;o<e;o++){const e=t[o];a.players.push({id:o+1,nickname:`Player ${o+1}`,role:e,roleName:n[e].name,team:n[e].team,isAlive:!0,isNominated:!1,votesReceived:0,protectedBy:null,killedBy:null,donCheckResult:null,komissarCheckResult:null,zhurnalistCheckResult:null,krasotkaLink:null,krasotkaNightlyChoice:null,oborotenTargets:[],nightActionCompleted:!1})}console.log("Roles Assigned:",a.players)}function c(){console.log("Rendering Role Assignment Screen with Table");const e=document.getElementById("role-assignment-screen");e.innerHTML="<h2>Role Assignment</h2>";const t=document.createElement("table");t.style.width="100%",t.setAttribute("border","1");const o=t.createTHead().insertRow();["Player #","Nickname","Role"].forEach((e=>{const t=document.createElement("th");t.textContent=e,o.appendChild(t)}));const i=t.createTBody();a.players.forEach((e=>{const t=i.insertRow();t.insertCell().textContent=e.id;const o=t.insertCell(),r=document.createElement("input");r.type="text",r.value=e.nickname,r.placeholder=`Player ${e.id}`,r.dataset.playerId=e.id,r.onchange=t=>{const n=a.players.find((t=>t.id===e.id));n&&(n.nickname=t.target.value||`Player ${e.id}`),console.log(`Nickname updated for Player ${e.id}: ${n.nickname}`)},o.appendChild(r);const l=t.insertCell(),s=document.createElement("select");s.dataset.playerId=e.id,Object.entries(n).forEach((([t,n])=>{const a=document.createElement("option");a.value=t,a.textContent=`${n.name} (${n.team})`,e.role===t&&(a.selected=!0),s.appendChild(a)})),s.onchange=t=>{const o=t.target.value,i=a.players.find((t=>t.id===e.id));i&&n[o]&&(i.role=o,i.roleName=n[o].name,i.team=n[o].team,console.log(`Player ${e.id} role changed to: ${i.roleName}`),d())},l.appendChild(s)})),e.appendChild(t);const r=document.createElement("div");r.id="assignment-validation-errors",e.appendChild(r);const l=document.createElement("div");l.id="assignment-validation-warnings",e.appendChild(l);const u=document.createElement("div");u.style.marginTop="20px";const p=document.createElement("button");p.textContent="Randomize Roles",p.onclick=()=>{g("Roles randomized."),s(),c()},u.appendChild(p);const h=document.createElement("button");h.textContent="Start Game",h.id="start-game",h.style.marginLeft="10px",h.onclick=m,u.appendChild(h),e.appendChild(u),d()}function d(){const e={};a.players.forEach((t=>{e[t.role]=(e[t.role]||0)+1}));const t=a.playerCount,o=a.players.length;let i=[],r=[];o!==t&&i.push(`Mismatch: Assigned roles (${o}) do not match player count (${t}).`),e.don&&1===e.don||i.push("Invalid assignment: Exactly one Don is required."),e.komissar&&1===e.komissar||i.push("Invalid assignment: Exactly one Komissar is required."),Object.keys(e).forEach((t=>{["mafia","citizen"].includes(t)||e[t]>1&&n[t]&&i.push(`Invalid assignment: Cannot have more than one ${n[t].name}.`)}));let l=0;a.players.forEach((e=>{"Black"===e.team?l++:"Red"===e.team?0:"Independent"===e.team&&0})),2*l>=t&&r.push("Warning: Black team starts strong!");const s=document.getElementById("assignment-validation-errors"),c=document.getElementById("assignment-validation-warnings"),d=document.getElementById("start-game");s&&(s.innerHTML=i.map((e=>`<p style="color: red;">${e}</p>`)).join("")),c&&(c.innerHTML=r.map((e=>`<p style="color: orange;">${e}</p>`)).join(""));const m=0===i.length;return d&&(d.disabled=!m),m}function m(){a.players.forEach((e=>{const t=document.getElementById(`nickname-${e.id}`);t&&t.value.trim()&&(e.nickname=t.value.trim())})),d()?(console.log("Starting Game with state:",a),a.dayNumber=1,a.currentPhase="Day",console.log("Initializing Game Screen"),u(),o("game"),T()):alert("Please fix the role assignment errors before starting the game.")}function u(){console.log(`Rendering Game Screen - Phase: ${a.currentPhase}, Day: ${a.dayNumber}`);const e=document.getElementById("player-display");e.innerHTML="",a.players.forEach((t=>{e.appendChild(function(e){const t=document.createElement("div");t.classList.add("player-card"),e.isAlive||t.classList.add("dead");t.dataset.playerId=e.id;const n=document.createElement("div");n.classList.add("player-number"),n.textContent=`#${e.id}`,t.appendChild(n);const o=document.createElement("div");o.classList.add("nickname"),o.textContent=e.nickname,t.appendChild(o);const i=document.createElement("div");i.classList.add("role"),i.textContent=e.roleName,t.appendChild(i);const r=document.createElement("div");if(r.classList.add("team"),r.textContent=e.team,r.classList.add(`team-${e.team.toLowerCase()}`),t.appendChild(r),e.isNominated){const e=document.createElement("div");e.textContent="NOMINATED",e.style.color="orange",e.style.fontWeight="bold",t.appendChild(e)}if("Day"===a.currentPhase&&e.isAlive){const n=document.createElement("button");n.textContent="Nominate",n.dataset.playerId=e.id,n.onclick=A,e.isNominated&&(n.textContent="Un-nominate",n.style.backgroundColor="#f0ad4e"),t.appendChild(n)}return t}(t))})),document.getElementById("timer-controls").innerHTML='\n            <h3>Timer</h3>\n            <div id="timer-display">01:00</div>\n            <button id="timer-30s">30s</button>\n            <button id="timer-45s">45s</button>\n            <button id="timer-60s">60s</button>\n            <button id="timer-pause">Pause</button>\n            <button id="timer-restart">Restart</button>\n        ',document.getElementById("timer-30s").onclick=()=>v(30),document.getElementById("timer-45s").onclick=()=>v(45),document.getElementById("timer-60s").onclick=()=>v(60),document.getElementById("timer-pause").onclick=N,document.getElementById("timer-restart").onclick=I;try{p()}catch(e){console.error("[RENDER][gameControls][ERROR]",e)}h()}function p(){const e=document.getElementById("game-controls");if(!a.gameOver)switch(e.setAttribute("data-phase",a.currentPhase||""),e.setAttribute("data-day",String(a.dayNumber)),console.log("[RENDER][gameControls] phase/day set to",a.currentPhase,a.dayNumber),e.innerHTML="",a.currentPhase){case"Day":e.innerHTML=`\n                    <h3 data-test-id="day-speaker-header">Day ${a.dayNumber} - Speaker Phase</h3>\n                    <p>Players give speeches. Nominate players using buttons on their cards.</p>\n                    <button id="proceed-to-voting">Proceed to Voting</button>\n                `,document.getElementById("proceed-to-voting").onclick=B;break;case"Voting":e.innerHTML=`<h3>Day ${a.dayNumber} - Voting Phase</h3>`;R(e,a.nominationOrder.map((e=>a.players.find((t=>t.id===e&&t.isAlive)))).filter((e=>e)));break;case"Night":e.innerHTML=`<h3>Night ${a.dayNumber}</h3><p>Processing night actions...</p>`;break;case"PostVoteReport":O();break;case"Report":e.innerHTML=`<h3>Night ${a.dayNumber} - Report</h3>`,document.getElementById("report-screen").classList.add("active")}}function h(){document.getElementById("log-list")}function g(e){a.log||(a.log=[]);const t=(new Date).toLocaleTimeString();a.log.push({timestamp:t,message:e}),h();const n=document.getElementById("log-list");n&&(n.scrollTop=n.scrollHeight)}t.playerCountInput.addEventListener("change",i),t.proceedToAssignmentButton.addEventListener("click",l),i(),t.mafiaCountInput.addEventListener("change",r),o("setup");let y=null,k=0,f=null,b=!1,$=0;function v(e,t){clearInterval(y),k=e,$=e,f=t,b=!1,C(),document.getElementById("timer-pause").textContent="Pause",y=setInterval((()=>{b||(k--,C(),k<=0&&(clearInterval(y),f&&f()))}),1e3),g(`Timer started for ${E(e)}.`)}function C(){const e=document.getElementById("timer-display");e&&(e.textContent=E(k))}function E(e){const t=Math.floor(e/60),n=e%60;return`${String(t).padStart(2,"0")}:${String(n).padStart(2,"0")}`}function N(){b=!b,document.getElementById("timer-pause").textContent=b?"Resume":"Pause",g(b?"Timer paused.":"Timer resumed.")}function I(){$>0&&(g("Timer restarted."),v($,f))}function T(){console.log("Starting Day Phase",a.dayNumber),a.currentPhase="Day",a.players.forEach((e=>e.isNominated=!1)),a.nominationOrder=[],g(`Day ${a.dayNumber} begins.`),u(),v(60,B),setTimeout((()=>{if(!a.gameOver&&"Day"===a.currentPhase){console.log("[DAY] Forcing re-render of game controls for Day",a.dayNumber),p();const e=document.getElementById("game-controls");e&&(console.log("[DAY][DEBUG] game-controls attrs after re-render:",e.getAttribute("data-phase"),e.getAttribute("data-day"),"visible?",!!e.offsetParent),console.log("[DAY][DEBUG] game-controls HTML snippet:",e.innerHTML.slice(0,120)))}}),0)}function A(e){const t=parseInt(e.target.dataset.playerId,10),n=a.players.find((e=>e.id===t));n&&n.isAlive&&(n.isNominated=!n.isNominated,g(`Player ${n.nickname} ${n.isNominated?"nominated.":"un-nominated."}`),n.isNominated?a.nominationOrder.includes(t)||(a.nominationOrder.push(t),console.log("[NOMINATION] Added",t,"order:",a.nominationOrder.join(","))):(a.nominationOrder=a.nominationOrder.filter((e=>e!==t)),console.log("[NOMINATION] Removed",t,"order:",a.nominationOrder.join(","))),console.log("Nomination Order:",a.nominationOrder),u())}function B(){clearInterval(y),a.currentPhase="Voting",a.eliminatedByVoteToday=[];const e=a.players.filter((e=>e.isAlive&&e.isNominated));return g(`Voting phase begins. Nominated: ${e.map((e=>e.nickname)).join(", ")||"None"}`),0===e.length?(g("No players nominated. Proceeding directly to Night Phase."),void L()):1===e.length?(g(`Only ${e[0].nickname} is nominated. Auto-eliminating.`),w(e[0].id,"vote"),void M()):(a.players.forEach((e=>e.votesReceived=0)),a.tieBreakCount=0,void u())}function R(e,t,n=!1){if(e.innerHTML=`<h3>${n?"Tie-Break Vote":"Vote"}</h3>`,0===t.length)return void(e.innerHTML+="<p>Error: No nominated players for vote.</p>");const o=document.createElement("form");o.id=n?"tie-break-vote-form":"vote-form",t.forEach((e=>{const t=document.createElement("div");t.classList.add("form-group");const n=document.createElement("label");n.htmlFor=`votes-${e.id}`,n.textContent=`Votes for ${e.nickname} (#${e.id}):`;const a=document.createElement("input");a.type="number",a.id=`votes-${e.id}`,a.name=`votes-${e.id}`,a.min="0",a.required=!0,a.dataset.playerId=e.id,t.appendChild(n),t.appendChild(a),o.appendChild(t)}));const i=document.createElement("button");i.type="submit",i.textContent="Submit Votes",o.appendChild(i),o.onsubmit=e=>{e.preventDefault(),function(e){const t=e?"tie-break-vote-form":"vote-form",n=document.getElementById(t);if(!n)return;const o=n.querySelectorAll('input[type="number"]');let i=0,r=[];o.forEach((e=>{const t=parseInt(e.dataset.playerId,10),n=parseInt(e.value,10),o=a.players.find((e=>e.id===t));o&&!isNaN(n)&&n>=0?(o.votesReceived=n,r.push({playerId:t,votes:n}),i+=n):console.warn(`Invalid vote input for player ${t}`)}));const l=a.players.filter((e=>e.isAlive)).length;if(i>l)return void alert(`Error: Total votes (${i}) exceed the number of living players (${l}). Please re-enter votes.`);g(`Votes cast (${i} total): ${r.map((e=>`${a.players.find((t=>t.id===e.playerId)).nickname}: ${e.votes}`)).join(", ")}`);let s=-1;r.forEach((e=>{e.votes>s&&(s=e.votes)}));const c=r.filter((e=>e.votes===s));if(1===c.length){const e=a.players.find((e=>e.id===c[0].playerId));g(`${e.nickname} received the most votes (${s}) and is eliminated.`),w(e.id,"vote"),M()}else c.length>1?function(e){if(g(`Tie in votes between ${e.map((e=>a.players.find((t=>t.id===e)).nickname)).join(" and ")}.`),a.tieBreakCount=(a.tieBreakCount||0)+1,a.tieBreakCount>=2)g("Persistent tie. Admin must decide."),function(e){document.getElementById("game-controls").innerHTML=`\n            <h3>Persistent Tie - Admin Decision</h3>\n            <p>Players tied: ${e.map((e=>a.players.find((t=>t.id===e)).nickname)).join(", ")}</p>\n            <button id="admin-eliminate-all">Eliminate All Tied</button>\n            <button id="admin-keep-all">Keep All Tied (Proceed to Night)</button>\n         `,document.getElementById("admin-eliminate-all").onclick=()=>{g(`Admin decided to eliminate all tied players: ${e.map((e=>a.players.find((t=>t.id===e)).nickname)).join(", ")}`),e.forEach((e=>w(e,"admin_tie_decision"))),M()},document.getElementById("admin-keep-all").onclick=()=>{g("Admin decided to keep all tied players."),M()}}(e);else{g("Initiating Tie-Break Vote.");const t=[];a.players.forEach((n=>{e.includes(n.id)?(n.isNominated=!0,n.isAlive&&t.push(n)):n.isNominated=!1})),u(),R(document.getElementById("game-controls"),t,!0)}}(c.map((e=>e.playerId))):(g("No player received the maximum votes (or votes were 0). Proceeding to Night Phase."),M())}(n)},e.appendChild(o)}function w(e,t,n=!1){const o=a.players.find((t=>t.id===e));o&&o.isAlive?(o.isAlive=!1,o.eliminationReason=t,o.eliminationDay=a.dayNumber,g(`Player ${o.nickname} (Role: ${o.roleName}, Team: ${o.team}) has been eliminated (${t}).`),"vote"!==t&&"admin_tie_decision"!==t||a.eliminatedByVoteToday.includes(e)||a.eliminatedByVoteToday.push(e),n||S()):console.warn(`Attempted to eliminate non-existent or already dead player ${e}`)}function M(){a.currentPhase="PostVoteReport",g("Voting concluded. Showing elimination results."),O(),u()}function O(){const e=document.getElementById("game-controls");if(e.innerHTML=`<h3>Day ${a.dayNumber} - Voting Results</h3>`,a.eliminatedByVoteToday.length>0){e.innerHTML+="<p>Eliminated by vote:</p><ul>";a.nominationOrder.filter((e=>a.eliminatedByVoteToday.includes(e))).map((e=>a.players.find((t=>t.id===e)))).forEach((t=>{t&&(e.innerHTML+=`<li>${t.nickname} (#${t.id}) - Role: ${t.roleName}</li>`)})),e.innerHTML+="</ul>"}else e.innerHTML+="<p>No players were eliminated by vote.</p>";const t=document.createElement("button");t.id="start-night-button",t.textContent="Start Night Phase",t.onclick=L,e.appendChild(t)}function L(){a.currentPhase="Night",g(`Night ${a.dayNumber} begins. Roles with night actions will proceed.`),a.players.forEach((e=>{e.protectedBy=null,e.killedBy=null,e.donCheckResult=null,e.komissarCheckResult=null,e.zhurnalistCheckResult=null,e.nightActionCompleted=!1,e.krasotkaNightlyChoice=null})),a.nightActionQueue=function(){const e=["mafia","don","komissar","oboroten","doctor","krasotka","zhurnalist","maniac"];let t=[];const o=a.players;return e.forEach((e=>{if("mafia"===e){if(o.some((e=>"Black"===e.team))){const e=o.some((e=>"Black"===e.team&&e.isAlive));t.push({roleKey:"mafia",promptText:x("mafia",null),isAlive:e})}}else{const a=o.find((t=>t.role===e));a&&n[e]?.nightAction&&t.push({playerId:a.id,roleKey:e,nickname:a.nickname,promptText:x(e,a),isAlive:a.isAlive})}})),console.log("Night Action Queue (incl. dead player turns):",t),t}(),a.currentNightActionIndex=-1,u(),D()}function x(e,t){switch(e){case"oboroten":return`${t?.nickname} (Oboroten), choose a target to switch (optional). Current: ${t?.oborotenTargets.join(", ")}.`;case"doctor":return`${t?.nickname} (Doctor), choose a player to protect.`;case"krasotka":return`${t?.nickname} (Krasotka), choose player to protect/link with tonight. If you die, they die too. If they are targeted, they are safe.`;case"don":return`${t?.nickname} (Don), choose a player to check for Komissar.`;case"komissar":return`${t?.nickname} (Komissar), choose a player to check their team.`;case"zhurnalist":return`${t?.nickname} (Zhurnalist), choose two players to check if they are on the same team.`;case"mafia":return"Mafia team, choose a player to eliminate.";case"maniac":return`${t?.nickname} (Maniac), choose a player to eliminate.`;default:return`Unknown action for ${e}`}}function D(){if(a.currentNightActionIndex++,a.currentNightActionIndex>=a.nightActionQueue.length)return void function(){g("Resolving night actions...");let e={eliminations:[],checks:[],protections:[],other:[]},t=[];const n=a.players.find((e=>"krasotka"===e.role&&e.isAlive)),o=a.mafiaKillTarget,i=a.players.filter((e=>"maniac"===e.killedBy)).map((e=>e.id));if(a.players.forEach((e=>e.killedBy=null)),a.mafiaKillTarget=null,o){const i=a.players.find((e=>e.id===o));if(i&&i.isAlive){let o=!1,r=null;if(n&&n.krasotkaNightlyChoice===i.id&&(g(`Mafia attempted to kill ${i.nickname}, but they were protected by Krasotka!`),e.protections.push(`Krasotka saved ${i.nickname} from Mafia.`),o=!0,r="Krasotka"),o||"doctor"!==i.protectedBy||(g(`Mafia attempted to kill ${i.nickname}, but they were saved by the Doctor!`),e.protections.push(`Doctor saved ${i.nickname} from Mafia.`),o=!0,r="Doctor"),!o)if("krasotka"===i.role&&null!==i.krasotkaNightlyChoice){const e=i.krasotkaNightlyChoice,n=a.players.find((t=>t.id===e));g(`Mafia killed Krasotka (${i.nickname})!`),w(i.id,"mafia",!0),t.push({id:i.id,nickname:i.nickname,by:"Mafia (Killed Krasotka)"}),n&&n.isAlive&&(g(`...and also killed ${n.nickname} who was with Krasotka!`),w(n.id,"mafia_krasotka_link",!0),t.push({id:n.id,nickname:n.nickname,by:"Mafia (With Krasotka)"}))}else g(`Mafia successfully killed ${i.nickname}.`),w(i.id,"mafia",!0),t.push({id:i.id,nickname:i.nickname,by:"Mafia"})}else g(`Mafia targeted ${i?i.nickname:`Player ${o}`}, but they were already dead or invalid.`)}i.forEach((o=>{const i=a.players.find((e=>e.id===o)),r=a.players.find((e=>"maniac"===e.role&&e.isAlive));if(i&&i.isAlive){let o=!1,l=null;if(n&&n.krasotkaNightlyChoice===i.id&&(g(`Maniac (${r?.nickname}) attempted to kill ${i.nickname}, but they were protected by Krasotka!`),e.protections.push(`Krasotka saved ${i.nickname} from Maniac.`),o=!0,l="Krasotka"),o||"doctor"!==i.protectedBy||(g(`Maniac (${r?.nickname}) attempted to kill ${i.nickname}, but they were saved by the Doctor!`),e.protections.push(`Doctor saved ${i.nickname} from Maniac.`),o=!0,l="Doctor"),!o)if(g(`Maniac (${r?.nickname}) successfully killed ${i.nickname}.`),"krasotka"===i.role&&null!==i.krasotkaNightlyChoice){const e=i.krasotkaNightlyChoice,n=a.players.find((t=>t.id===e));w(i.id,"maniac",!0),t.push({id:i.id,nickname:i.nickname,by:"Maniac (Killed Krasotka)"}),n&&n.isAlive&&(g(`...and also killed ${n.nickname} who was with Krasotka!`),w(n.id,"maniac_krasotka_link",!0),t.push({id:n.id,nickname:n.nickname,by:"Maniac (With Krasotka)"}))}else w(i.id,"maniac",!0),t.push({id:i.id,nickname:i.nickname,by:"Maniac"})}else i&&!i.isAlive?g(`Maniac (${r?.nickname}) targeted ${i.nickname}, but they were already eliminated.`):g(`Maniac (${r?.nickname}) targeted Player ${o}, but they were invalid or already dead.`)}));const r=a.players.find((e=>"oboroten"===e.role&&!e.isAlive&&e.eliminationDay===a.dayNumber));r&&"vote"!==r.eliminationReason&&"admin_tie_decision"!==r.eliminationReason&&Array.isArray(r.oborotenTargets)&&2===r.oborotenTargets.length&&r.oborotenTargets.forEach((o=>{const i=a.players.find((e=>e.id===o));if(i&&i.isAlive){const o="doctor"===i.protectedBy,r=n&&n.krasotkaNightlyChoice===i.id;if(o||r)g(`Oboroten's death attempted to drag down ${i.nickname}, but they were protected by ${o?"Doctor":"Krasotka"}!`),e.protections.push(`${o?"Doctor":"Krasotka"} saved ${i.nickname} from Oboroten cascade.`);else if(g(`Oboroten's death drags down ${i.nickname}!`),w(i.id,"oboroten_death",!0),t.some((e=>e.id===i.id))||t.push({id:i.id,nickname:i.nickname,by:"Oboroten Death"}),"krasotka"===i.role&&null!==i.krasotkaNightlyChoice){const e=a.players.find((e=>e.id===i.krasotkaNightlyChoice));e&&e.isAlive&&(g(`...and also drags down ${e.nickname} who was with Krasotka!`),w(e.id,"oboroten_krasotka_link",!0),t.some((t=>t.id===e.id))||t.push({id:e.id,nickname:e.nickname,by:"Oboroten (With Krasotka)"}))}}}));const l=a.players.find((e=>"oboroten"===e.role&&e.isAlive));l&&l.oborotenTargets.forEach((n=>{const o=a.players.find((e=>e.id===n));!o||o.isAlive||t.some((e=>e.id===n))?t.some((e=>e.id===n))&&(g(`Oboroten's target ${o.nickname} was eliminated this night!`),e.other.push(`Oboroten target ${o.nickname} eliminated.`)):(g(`Oboroten's target ${o.nickname} was already dead.`),e.other.push(`Oboroten target ${o.nickname} was already dead.`))}));a.players.forEach((t=>{if(t.isAlive){if(t.donCheckResult){const n=t.donCheckResult;e.checks.push(`Don (${t.nickname}) checked ${n.targetNickname}: ${n.isKomissar?"IS Komissar":"NOT Komissar"}.`)}if(t.komissarCheckResult){const n=t.komissarCheckResult;e.checks.push(`Komissar (${t.nickname}) checked ${n.targetNickname}: Team is ${n.targetTeam}.`)}if(t.zhurnalistCheckResult){const n=t.zhurnalistCheckResult;e.checks.push(`Zhurnalist (${t.nickname}) checked ${n.targetNickname1} and ${n.targetNickname2}: ${n.sameTeam?"SAME Team":"DIFFERENT Teams"}.`)}}})),e.eliminations=t,a.lastNightReport=e,console.log("Night Report:",e),a.gameOver||S();a.gameOver,P()}();const e=a.nightActionQueue[a.currentNightActionIndex];!function(e,t){const n=t.roleKey.charAt(0).toUpperCase()+t.roleKey.slice(1);e.innerHTML=`<h3>Night ${a.dayNumber} - ${n} Action</h3>`,e.innerHTML+=`<p>${t.promptText}</p>`;const o=document.createElement("form");if(o.id="night-action-form",t.isAlive){!function(e,t,n){const o=a.players.filter((e=>e.isAlive)),i=a.players.find((e=>e.id===n));switch(t){case"doctor":case"don":case"komissar":case"maniac":case"mafia":const r=document.createElement("label");r.textContent="Target: ";const l=document.createElement("select");l.id="night-target",l.required=!0,l.add(new Option("--Select Player--","",!0,!0)),o.forEach((e=>{let a=!0;"doctor"===t&&e.id===n&&(a=!1),a&&l.add(new Option(`${e.nickname} (#${e.id}) - ${e.roleName}`,e.id))})),r.appendChild(l),e.appendChild(r);break;case"krasotka":const s=document.createElement("label");s.textContent="Protect/Link tonight: ";const c=document.createElement("select");c.id="night-target",c.add(new Option("-- No One --","null")),o.forEach((e=>{e.id!==n&&c.add(new Option(`${e.nickname} (#${e.id}) - ${e.roleName}`,e.id))})),s.appendChild(c),e.appendChild(s);break;case"zhurnalist":const d=document.createElement("label");d.textContent="Player 1: ";const m=document.createElement("select");m.id="night-target1",m.required=!0,m.add(new Option("--Select Player 1--","",!0,!0)),o.forEach((e=>{m.add(new Option(`${e.nickname} (#${e.id}) - ${e.roleName}`,e.id))})),d.appendChild(m),e.appendChild(d),e.appendChild(document.createElement("br"));const u=document.createElement("label");u.textContent="Player 2: ";const p=document.createElement("select");p.id="night-target2",p.required=!0,p.add(new Option("--Select Player 2--","",!0,!0)),o.forEach((e=>{p.add(new Option(`${e.nickname} (#${e.id}) - ${e.roleName}`,e.id))})),u.appendChild(p),e.appendChild(u);break;case"oboroten":const h=i?i.oborotenTargets:[];if(h.length<2){e.innerHTML+="<p>Select TWO distinct players as initial Oboroten targets.</p>";const t=document.createElement("label");t.textContent="Initial Target 1: ";const a=document.createElement("select");a.id="oboroten-target1",a.required=!0,a.add(new Option("--Select Target 1--","",!0,!0)),o.forEach((e=>{e.id!==n&&a.add(new Option(`${e.nickname} (#${e.id}) - ${e.roleName}`,e.id))})),t.appendChild(a),e.appendChild(t),e.appendChild(document.createElement("br"));const i=document.createElement("label");i.textContent="Initial Target 2: ";const r=document.createElement("select");r.id="oboroten-target2",r.required=!0,r.add(new Option("--Select Target 2--","",!0,!0)),o.forEach((e=>{e.id!==n&&r.add(new Option(`${e.nickname} (#${e.id}) - ${e.roleName}`,e.id))})),i.appendChild(r),e.appendChild(i),e.appendChild(document.createElement("p")).textContent="Both selections required. They must be different."}else{e.innerHTML+=`<p>Current Targets: ${h.map((e=>{const t=a.players.find((t=>t.id===e));return t?`${t.nickname} (#${t.id}) - ${t.roleName}`:`ID ${e}`})).join(" and ")}</p>`;const t=document.createElement("label");t.textContent="Target to remove: ";const i=document.createElement("select");i.id="night-target-remove",i.add(new Option("--Keep Current--","",!0,!0)),h.forEach((e=>{const t=a.players.find((t=>t.id===e));t&&i.add(new Option(`${t.nickname} (#${e}) - ${t.roleName}`,e))})),t.appendChild(i),e.appendChild(t),e.appendChild(document.createElement("br"));const r=document.createElement("label");r.textContent="Target to add: ";const l=document.createElement("select");l.id="night-target-add",l.add(new Option("--Select New Target--","",!0,!0)),o.forEach((e=>{e.id===n||h.includes(e.id)||l.add(new Option(`${e.nickname} (#${e.id}) - ${e.roleName}`,e.id))})),r.appendChild(l),e.appendChild(r),e.appendChild(document.createElement("p")).textContent="(Select both to switch, or leave blank/default to keep current targets)"}break;default:e.innerHTML+="<p>Action input not implemented yet.</p>"}}(o,t.roleKey,t.playerId);const e=document.createElement("button");e.type="submit",e.textContent="Submit Action",e.classList.add("submit-action"),o.appendChild(e);const n=document.createElement("button");n.type="button",n.textContent="Skip Action",n.classList.add("skip-action"),n.onclick=()=>{g(`${t.nickname||"Mafia"} skipped their night action.`),D()},o.appendChild(n),o.onsubmit=e=>{e.preventDefault(),function(e,t){const n=document.getElementById("night-action-form");if(!n)return;const o=a.players.find((e=>e.id===t));let i=null,r=null,l=null,s=null,c=null,d=null;if(["doctor","don","komissar","maniac","mafia","krasotka"].includes(e)){const t=n.querySelector("#night-target");if(t&&t.value)i="null"===t.value?null:parseInt(t.value,10),s=i?a.players.find((e=>e.id===i)):null;else{if("krasotka"!==e)return void alert("Please select a target player.");i=null,s=null}}else if("zhurnalist"===e){const e=n.querySelector("#night-target1"),t=n.querySelector("#night-target2");if(!(e&&e.value&&t&&t.value))return void alert("Please select two target players.");if(r=parseInt(e.value,10),l=parseInt(t.value,10),r===l)return void alert("Please select two different players.");c=a.players.find((e=>e.id===r)),d=a.players.find((e=>e.id===l))}else if("oboroten"===e&&o){if(o.oborotenTargets.length<2){const e=n.querySelector("#oboroten-target1"),t=n.querySelector("#oboroten-target2"),a=e&&e.value?parseInt(e.value,10):null,i=t&&t.value?parseInt(t.value,10):null;return a&&i?a===i?void alert("Oboroten initial targets must be different."):(o.oborotenTargets=[a,i],g(`Oboroten (${o.nickname}) set initial targets to #${a} and #${i}.`),o.nightActionCompleted=!0,void D()):void alert("Please select two distinct initial targets for Oboroten.")}{const e=n.querySelector("#night-target-remove"),t=n.querySelector("#night-target-add"),a=e&&e.value?parseInt(e.value,10):null,i=t&&t.value?parseInt(t.value,10):null;if(!a||!i)return a||i?void alert("To switch Oboroten targets, select both a target to remove AND a target to add."):(g(`${o.nickname} (Oboroten) kept current targets.`),o.nightActionCompleted=!0,void D());r=a,l=i}}let m="";switch(e){case"doctor":s&&(s.protectedBy="doctor",m=`Doctor (${o.nickname}) chose to protect ${s.nickname}.`);break;case"krasotka":o?(o.krasotkaNightlyChoice=i,m=s?`Krasotka (${o.nickname}) chose to protect ${s.nickname} tonight.`:`Krasotka (${o.nickname}) chose to protect no one tonight.`):m="Error: Krasotka player not found for action submission.";break;case"don":s&&(o.donCheckResult={targetId:i,targetNickname:s.nickname,isKomissar:"komissar"===s.role},m=`Don (${o.nickname}) checked ${s.nickname}.`);break;case"komissar":s&&(o.komissarCheckResult={targetId:i,targetNickname:s.nickname,targetTeam:s.team},m=`Komissar (${o.nickname}) checked ${s.nickname}.`);break;case"zhurnalist":c&&d&&(o.zhurnalistCheckResult={targetId1:r,targetNickname1:c.nickname,targetId2:l,targetNickname2:d.nickname,sameTeam:c.team===d.team},m=`Zhurnalist (${o.nickname}) checked ${c.nickname} and ${d.nickname}.`);break;case"mafia":s&&(a.mafiaKillTarget=i,m=`Mafia chose to target ${s.nickname}.`);break;case"maniac":s&&(s.killedBy="maniac",m=`Maniac (${o.nickname}) targeted ${s.nickname}.`);break;case"oboroten":if(o&&r&&l){const e=o.oborotenTargets.indexOf(r);e>-1&&o.oborotenTargets.splice(e,1),o.oborotenTargets.push(l),m=`Oboroten (${o.nickname}) switched target from #${r} to #${l}. New targets: ${o.oborotenTargets.join(", ")}.`}}m&&g(m);o?o.nightActionCompleted=!0:"mafia"===e&&a.players.forEach((e=>{"mafia"===e.role&&e.isAlive&&(e.nightActionCompleted=!0)}));D()}(t.roleKey,t.playerId)}}else{o.innerHTML+=`<p><i>(${"mafia"===t.roleKey?"No Mafia members left":`${t.nickname} is eliminated`})</i></p>`;const e=document.createElement("button");e.type="button",e.textContent="Next Action",e.onclick=()=>{D()},o.appendChild(e)}e.appendChild(o)}(document.getElementById("game-controls"),e)}function P(){a.currentPhase="Report",g(`Night ${a.dayNumber} ended. Displaying report.`),function(){const e=document.getElementById("report-screen");e.innerHTML=`<h2>Night ${a.dayNumber} Report</h2>`;const t=a.lastNightReport||{eliminations:[],checks:[],protections:[],other:[]};if(e.innerHTML+="<h3>Eliminations:</h3>",t.eliminations.length>0){const n=document.createElement("ul");t.eliminations.forEach((e=>{const t=a.players.find((t=>t.id===e.id));n.innerHTML+=`<li>${e.nickname} (Role: ${t?.roleName}, Team: ${t?.team}) killed by ${e.by}.</li>`})),e.appendChild(n)}else e.innerHTML+="<p>No one was eliminated.</p>";if(e.innerHTML+="<h3>Protections:</h3>",t.protections.length>0){const n=document.createElement("ul");t.protections.forEach((e=>n.innerHTML+=`<li>${e}</li>`)),e.appendChild(n)}else e.innerHTML+="<p>No protections were noted (or needed).</p>";if(e.innerHTML+="<h3>Checks:</h3>",t.checks.length>0){const n=document.createElement("ul");t.checks.forEach((e=>n.innerHTML+=`<li>${e}</li>`)),e.appendChild(n)}else e.innerHTML+="<p>No checks were performed or reported.</p>";if(e.innerHTML+="<h3>Other Events:</h3>",t.other.length>0){const n=document.createElement("ul");t.other.forEach((e=>n.innerHTML+=`<li>${e}</li>`)),e.appendChild(n)}else e.innerHTML+="<p>No other significant events.</p>";const n=document.createElement("button");n.id="next-day",n.textContent=`Start Day ${a.dayNumber+1}`,n.onclick=()=>{if(console.log("[REPORT] Next Day button clicked. dayNumber before increment:",a.dayNumber),S(!0))console.log("Game already won, cannot start next day.");else{a.dayNumber++,console.log("[REPORT] Incremented dayNumber to",a.dayNumber);const e=document.getElementById("report-screen"),t=document.getElementById("game-screen");e&&e.classList.remove("active"),t&&t.classList.add("active"),o("game"),T(),console.log("[TRANSITION] Day phase started. game-screen active?",t?.classList.contains("active"))}},e.appendChild(n),u()}(),o("report")}function S(e=!1){const t=a.players.filter((e=>e.isAlive)),n=t.length;if(console.log("[WIN CHECK] Living count:",n),0===n)return K("Draw","All players were eliminated simultaneously."),!0;const o={Red:t.filter((e=>"Red"===e.team)).length,Black:t.filter((e=>"Black"===e.team)).length,Independent:t.filter((e=>"Independent"===e.team)).length};console.log("[WIN CHECK] Teams:",o);const i=t.find((e=>"maniac"===e.role)),r=t.find((e=>"oboroten"===e.role));if(o.Independent>0&&i&&1===n&&i)return K("Maniac",`${i.nickname} is the last one standing.`),!0;if(r){const e=r.oborotenTargets,t=a.players.find((t=>t.id===e[0])),n=a.players.find((t=>t.id===e[1]));2===e.length&&t&&!t.isAlive&&n&&n.isAlive}if(o.Black>0&&o.Black>=o.Red+o.Independent)return console.log("[WIN CHECK] Black win condition met"),K("Black Team (Mafia)",`Mafia (${o.Black}) equal or outnumber others (${o.Red+o.Independent}).`),!0;if(0===o.Black&&0===o.Independent){if(o.Red>0)return K("Red Team (Citizens)","All Mafia and Independents have been eliminated."),!0;console.warn("Win check: Red team wins condition met, but red count is 0?")}return e||console.log("No win condition met yet."),!1}function K(e,t){if(a.gameOver)return;a.gameOver=!0,g(`GAME OVER! Winner: ${e}. Reason: ${t}`),alert(`GAME OVER!\nWinner: ${e}\nReason: ${t}`);const n=document.getElementById("game-controls");n&&(n.innerHTML=`<h2>Game Over! Winner: ${e}</h2><p>${t}</p><button onclick="window.location.reload()">New Game</button>`);const o=document.getElementById("timer-controls");o&&(o.innerHTML="");const i=document.getElementById("next-day");i&&(i.textContent="New Game",i.onclick=()=>window.location.reload())}if("undefined"!=typeof window){window.addEventListener("error",(e=>{console.log("[WINDOW][ERROR]",e.message)}));const e=console.error;console.error=function(...t){e.apply(console,t);try{console.log("[CONSOLE][ERROR-ALIAS]",t.map((e=>e&&e.message?e.message:e)).join(" "))}catch(e){}},window.__mafiaDebug=window.__mafiaDebug||{},Object.assign(window.__mafiaDebug,{getState:()=>a,forceRender:()=>u(),startDay:()=>T(),startVoting:()=>B(),eliminate:(e,t="debug")=>w(e,t),winCheck:()=>S()}),console.log("[DEBUG] __mafiaDebug API exposed (in-scope)")}}))</script></body></html>