<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>OK Antalya / Mafia Academy</title><style>body{font-family:sans-serif;line-height:1.6;margin:20px;background-color:#f4f4f4}.container{max-width:1200px;margin:auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,.1)}h1,h2,h3{text-align:center;color:#333}.screen{display:none}.screen.active{display:block}.form-group{margin-bottom:15px}label{display:block;margin-bottom:5px;font-weight:700}input[type=number]{width:60px;padding:8px;border:1px solid #ccc;border-radius:4px}button{display:inline-block;background:#5cb85c;color:#fff;padding:10px 20px;border:none;border-radius:4px;cursor:pointer;font-size:16px;margin-top:10px}button:hover{background:#4cae4c}#role-selection label{display:inline-block;margin-right:15px}#role-selection input[type=checkbox]{margin-right:5px}#role-count-validation,#team-balance-validation{color:red;font-weight:700;margin-top:10px}#player-display{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px;margin-top:20px}.player-card{border:1px solid #ccc;padding:10px;border-radius:5px;background-color:#f9f9f9;text-align:center}.player-card.dead{opacity:.5;background-color:#ddd}.player-card .role{font-style:italic;color:#666}.player-card .team-red{color:red;font-weight:700}.player-card .team-black{color:#000;font-weight:700}.player-card .team-independent{color:#00f;font-weight:700}#timer-controls{margin-top:20px;text-align:center}#timer-display{font-size:2em;font-weight:700;margin-bottom:10px}#timer-controls button{margin:0 5px}#game-controls{margin-top:20px;text-align:center}#game-log{margin-top:30px;border-top:1px solid #eee;padding-top:20px}#log-list{list-style-type:none;padding:0;max-height:200px;overflow-y:auto;border:1px solid #eee;padding:10px}#log-list li{margin-bottom:5px;font-size:.9em;color:#555}</style></head><body><div class="container"><h1>OK Antalya / Mafia Academy 2025</h1><div id="setup-screen" class="screen active"><h2>Game Setup</h2><div class="form-group"><label for="player-count">Number of Players (5-20):</label> <input type="number" id="player-count" name="player-count" min="5" max="20" value="10"></div><div class="form-group"><h3>Role Configuration</h3><p>Mandatory Roles: Don, Komissar</p><div class="form-group"><label for="mafia-count">Number of Mafia:</label> <input type="number" id="mafia-count" name="mafia-count" min="1" value="1"></div><div id="role-selection"></div><p id="role-count-validation"></p><p id="team-balance-validation"></p></div><button id="proceed-to-assignment">Proceed to Role Assignment</button></div><div id="role-assignment-screen" class="screen"><h2>Role Assignment</h2><button id="start-game">Start Game</button></div><div id="game-screen" class="screen"><h2>Game In Progress</h2><div id="player-display"></div><div id="timer-controls"></div><div id="game-controls"></div><div id="game-log"><h3>Game Log</h3><ul id="log-list"></ul></div></div><div id="report-screen" class="screen"><h2>Night Report</h2><button id="next-day">Start Next Day</button></div></div><script>document.addEventListener("DOMContentLoaded",(()=>{const e={setup:document.getElementById("setup-screen"),roleAssignment:document.getElementById("role-assignment-screen"),game:document.getElementById("game-screen"),report:document.getElementById("report-screen")},t={playerCountInput:document.getElementById("player-count"),roleSelectionDiv:document.getElementById("role-selection"),roleCountValidation:document.getElementById("role-count-validation"),teamBalanceValidation:document.getElementById("team-balance-validation"),proceedToAssignmentButton:document.getElementById("proceed-to-assignment"),mafiaCountInput:document.getElementById("mafia-count")},n={don:{name:"Don",team:"Black",nightAction:!0,mandatory:!0},mafia:{name:"Mafia",team:"Black",nightAction:!0,mandatory:!1},komissar:{name:"Komissar",team:"Red",nightAction:!0,mandatory:!0},doctor:{name:"Doctor",team:"Red",nightAction:!0,mandatory:!1},krasotka:{name:"Krasotka",team:"Red",nightAction:!0,mandatory:!1},oboroten:{name:"Oboroten",team:"Red",nightAction:!0,mandatory:!1},zhurnalist:{name:"Zhurnalist",team:"Red",nightAction:!0,mandatory:!1},afferist:{name:"Afferist",team:"Red",nightAction:!1,mandatory:!1},citizen:{name:"Citizen",team:"Red",nightAction:!1,mandatory:!1},maniac:{name:"Maniac",team:"Independent",nightAction:!0,mandatory:!1}};let a={currentScreen:"setup",playerCount:10,selectedRoles:[],players:[],currentPhase:null,dayNumber:0,nominationOrder:[],manualMafiaCount:1,eliminatedByVoteToday:[]};function i(t){a.currentScreen=t,Object.values(e).forEach((e=>e.classList.remove("active"))),e[t]?e[t].classList.add("active"):console.error(`Screen "${t}" not found.`)}function o(){a.playerCount=parseInt(t.playerCountInput.value,10),(isNaN(a.playerCount)||a.playerCount<5||a.playerCount>20)&&(a.playerCount=10,t.playerCountInput.value=a.playerCount);let e=1;a.playerCount>=7&&e++,a.playerCount>=11&&e++,a.playerCount>=16&&e++,t.mafiaCountInput.value=e,function(){t.roleSelectionDiv.innerHTML="";a.playerCount;Object.entries(n).filter((([e,t])=>!t.mandatory&&"mafia"!==e&&"citizen"!==e)).forEach((([e,n])=>{const a=document.createElement("label"),i=document.createElement("input");i.type="checkbox",i.value=e,i.id=`role-${e}`,i.addEventListener("change",r),a.htmlFor=`role-${e}`,a.appendChild(i),a.appendChild(document.createTextNode(` ${n.name} (${n.team})`)),t.roleSelectionDiv.appendChild(a)})),r()}()}function r(){const e=t.roleSelectionDiv.querySelectorAll('input[type="checkbox"]:checked');a.selectedRoles=Array.from(e).map((e=>e.value));const i=a.playerCount;let o=2,r=0,l=parseInt(t.mafiaCountInput.value,10);const c=Math.max(1,i-a.selectedRoles.length-2);isNaN(l)||l<1?(l=1,t.mafiaCountInput.value=l):l>c&&(l=c,t.mafiaCountInput.value=l),a.manualMafiaCount=l,o+=l,o+=a.selectedRoles.length,r=i-o,t.roleCountValidation.textContent="",t.teamBalanceValidation.textContent="",t.proceedToAssignmentButton.disabled=!1,r<0?(t.roleCountValidation.textContent=`Too many roles selected (${o-l} optional + ${l} Mafia). Maximum is ${i-2}.`,t.proceedToAssignmentButton.disabled=!0):o>i?(t.roleCountValidation.textContent=`Selected roles (${o}) exceed player count (${i}).`,t.proceedToAssignmentButton.disabled=!0):t.roleCountValidation.textContent=`Selected: ${a.selectedRoles.length} optional roles + ${l} Mafia + ${r} Citizens + Don + Komissar = ${i} total.`;const s=l+(n.don.mandatory?1:0),d=r+(n.komissar.mandatory?1:0)+a.selectedRoles.filter((e=>"Red"===n[e].team)).length,m=a.selectedRoles.filter((e=>"Independent"===n[e].team)).length;t.proceedToAssignmentButton.disabled||(t.teamBalanceValidation.textContent=`Teams: Black: ${s}, Red: ${d}, Independent: ${m}`,2*s>=i&&(t.teamBalanceValidation.textContent+=" (Warning: Black team starts strong!)"))}function l(){t.proceedToAssignmentButton.disabled?alert("Please fix the role selection errors before proceeding."):(console.log("Proceeding to Role Assignment with:",a),console.log("Initializing Role Assignment Screen"),document.getElementById("start-game").addEventListener("click",m),c(),s(),i("roleAssignment"))}function c(){a.players=[];const e=a.playerCount;let t=["don","komissar"];const i=a.manualMafiaCount;for(let e=0;e<i;e++)t.push("mafia");t.push(...a.selectedRoles);const o=e-t.length;for(let e=0;e<o;e++)t.push("citizen");for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}for(let i=0;i<e;i++){const e=t[i];a.players.push({id:i+1,nickname:`Player ${i+1}`,role:e,roleName:n[e].name,team:n[e].team,isAlive:!0,isNominated:!1,votesReceived:0,protectedBy:null,killedBy:null,donCheckResult:null,komissarCheckResult:null,zhurnalistCheckResult:null,krasotkaLink:null,krasotkaNightlyChoice:null,oborotenTargets:[],nightActionCompleted:!1})}console.log("Roles Assigned:",a.players)}function s(){console.log("Rendering Role Assignment Screen with Table");const e=document.getElementById("role-assignment-screen");e.innerHTML="<h2>Role Assignment</h2>";const t=document.createElement("table");t.style.width="100%",t.setAttribute("border","1");const i=t.createTHead().insertRow();["Player #","Nickname","Role"].forEach((e=>{const t=document.createElement("th");t.textContent=e,i.appendChild(t)}));const o=t.createTBody();a.players.forEach((e=>{const t=o.insertRow();t.insertCell().textContent=e.id;const i=t.insertCell(),r=document.createElement("input");r.type="text",r.value=e.nickname,r.placeholder=`Player ${e.id}`,r.dataset.playerId=e.id,r.onchange=t=>{const n=a.players.find((t=>t.id===e.id));n&&(n.nickname=t.target.value||`Player ${e.id}`),console.log(`Nickname updated for Player ${e.id}: ${n.nickname}`)},i.appendChild(r);const l=t.insertCell(),c=document.createElement("select");c.dataset.playerId=e.id,Object.entries(n).forEach((([t,n])=>{const a=document.createElement("option");a.value=t,a.textContent=`${n.name} (${n.team})`,e.role===t&&(a.selected=!0),c.appendChild(a)})),c.onchange=t=>{const i=t.target.value,o=a.players.find((t=>t.id===e.id));o&&n[i]&&(o.role=i,o.roleName=n[i].name,o.team=n[i].team,console.log(`Player ${e.id} role changed to: ${o.roleName}`),d())},l.appendChild(c)})),e.appendChild(t);const r=document.createElement("div");r.id="assignment-validation-errors",e.appendChild(r);const l=document.createElement("div");l.id="assignment-validation-warnings",e.appendChild(l);const u=document.createElement("div");u.style.marginTop="20px";const p=document.createElement("button");p.textContent="Randomize Roles",p.onclick=()=>{h("Roles randomized."),c(),s()},u.appendChild(p);const y=document.createElement("button");y.textContent="Start Game",y.id="start-game",y.style.marginLeft="10px",y.onclick=m,u.appendChild(y),e.appendChild(u),d()}function d(){const e={};a.players.forEach((t=>{e[t.role]=(e[t.role]||0)+1}));const t=a.playerCount,i=a.players.length;let o=[],r=[];i!==t&&o.push(`Mismatch: Assigned roles (${i}) do not match player count (${t}).`),e.don&&1===e.don||o.push("Invalid assignment: Exactly one Don is required."),e.komissar&&1===e.komissar||o.push("Invalid assignment: Exactly one Komissar is required."),Object.keys(e).forEach((t=>{["mafia","citizen"].includes(t)||e[t]>1&&n[t]&&o.push(`Invalid assignment: Cannot have more than one ${n[t].name}.`)}));let l=0;a.players.forEach((e=>{"Black"===e.team?l++:"Red"===e.team?0:"Independent"===e.team&&0})),2*l>=t&&r.push("Warning: Black team starts strong!");const c=document.getElementById("assignment-validation-errors"),s=document.getElementById("assignment-validation-warnings"),d=document.getElementById("start-game");c&&(c.innerHTML=o.map((e=>`<p style="color: red;">${e}</p>`)).join("")),s&&(s.innerHTML=r.map((e=>`<p style="color: orange;">${e}</p>`)).join(""));const m=0===o.length;return d&&(d.disabled=!m),m}function m(){a.players.forEach((e=>{const t=document.getElementById(`nickname-${e.id}`);t&&t.value.trim()&&(e.nickname=t.value.trim())})),d()?(console.log("Starting Game with state:",a),a.dayNumber=1,a.currentPhase="Day",console.log("Initializing Game Screen"),u(),i("game"),T()):alert("Please fix the role assignment errors before starting the game.")}function u(){console.log(`Rendering Game Screen - Phase: ${a.currentPhase}, Day: ${a.dayNumber}`);const e=document.getElementById("player-display");e.innerHTML="",a.players.forEach((t=>{e.appendChild(function(e){const t=document.createElement("div");t.classList.add("player-card"),e.isAlive||t.classList.add("dead");t.dataset.playerId=e.id;const n=document.createElement("div");n.classList.add("player-number"),n.textContent=`#${e.id}`,t.appendChild(n);const i=document.createElement("div");i.classList.add("nickname"),i.textContent=e.nickname,t.appendChild(i);const o=document.createElement("div");o.classList.add("role"),o.textContent=e.roleName,t.appendChild(o);const r=document.createElement("div");if(r.classList.add("team"),r.textContent=e.team,r.classList.add(`team-${e.team.toLowerCase()}`),t.appendChild(r),e.isNominated){const e=document.createElement("div");e.textContent="NOMINATED",e.style.color="orange",e.style.fontWeight="bold",t.appendChild(e)}if("Day"===a.currentPhase&&e.isAlive){const n=document.createElement("button");n.textContent="Nominate",n.dataset.playerId=e.id,n.onclick=N,e.isNominated&&(n.textContent="Un-nominate",n.style.backgroundColor="#f0ad4e"),t.appendChild(n)}return t}(t))})),document.getElementById("timer-controls").innerHTML='\n            <h3>Timer</h3>\n            <div id="timer-display">01:00</div>\n            <button id="timer-30s">30s</button>\n            <button id="timer-45s">45s</button>\n            <button id="timer-60s">60s</button>\n            <button id="timer-pause">Pause</button>\n            <button id="timer-restart">Restart</button>\n        ',document.getElementById("timer-30s").onclick=()=>v(30),document.getElementById("timer-45s").onclick=()=>v(45),document.getElementById("timer-60s").onclick=()=>v(60),document.getElementById("timer-pause").onclick=E,document.getElementById("timer-restart").onclick=I,function(){const e=document.getElementById("game-controls");switch(e.innerHTML="",a.currentPhase){case"Day":e.innerHTML=`\n                    <h3>Day ${a.dayNumber} - Speaker Phase</h3>\n                    <p>Players give speeches. Nominate players using buttons on their cards.</p>\n                    <button id="proceed-to-voting">Proceed to Voting</button>\n                `,document.getElementById("proceed-to-voting").onclick=A;break;case"Voting":e.innerHTML=`<h3>Day ${a.dayNumber} - Voting Phase</h3>`;M(e,a.nominationOrder.map((e=>a.players.find((t=>t.id===e&&t.isAlive)))).filter((e=>e)));break;case"Night":e.innerHTML=`<h3>Night ${a.dayNumber}</h3><p>Processing night actions...</p>`;break;case"PostVoteReport":w();break;case"Report":e.innerHTML=`<h3>Night ${a.dayNumber} - Report</h3>`,document.getElementById("report-screen").classList.add("active")}}(),p()}function p(){document.getElementById("log-list")}function h(e){a.log||(a.log=[]);const t=(new Date).toLocaleTimeString();a.log.push({timestamp:t,message:e}),p();const n=document.getElementById("log-list");n&&(n.scrollTop=n.scrollHeight)}t.playerCountInput.addEventListener("change",o),t.proceedToAssignmentButton.addEventListener("click",l),o(),t.mafiaCountInput.addEventListener("change",r),i("setup");let y=null,k=0,g=null,f=!1,$=0;function v(e,t){clearInterval(y),k=e,$=e,g=t,f=!1,C(),document.getElementById("timer-pause").textContent="Pause",y=setInterval((()=>{f||(k--,C(),k<=0&&(clearInterval(y),g&&g()))}),1e3),h(`Timer started for ${b(e)}.`)}function C(){const e=document.getElementById("timer-display");e&&(e.textContent=b(k))}function b(e){const t=Math.floor(e/60),n=e%60;return`${String(t).padStart(2,"0")}:${String(n).padStart(2,"0")}`}function E(){f=!f,document.getElementById("timer-pause").textContent=f?"Resume":"Pause",h(f?"Timer paused.":"Timer resumed.")}function I(){$>0&&(h("Timer restarted."),v($,g))}function T(){console.log("Starting Day Phase",a.dayNumber),a.currentPhase="Day",a.players.forEach((e=>e.isNominated=!1)),a.nominationOrder=[],h(`Day ${a.dayNumber} begins.`),u(),v(60,A)}function N(e){const t=parseInt(e.target.dataset.playerId,10),n=a.players.find((e=>e.id===t));n&&n.isAlive&&(n.isNominated=!n.isNominated,h(`Player ${n.nickname} ${n.isNominated?"nominated.":"un-nominated."}`),n.isNominated?a.nominationOrder.includes(t)||a.nominationOrder.push(t):a.nominationOrder=a.nominationOrder.filter((e=>e!==t)),console.log("Nomination Order:",a.nominationOrder),u())}function A(){clearInterval(y),a.currentPhase="Voting",a.eliminatedByVoteToday=[];const e=a.players.filter((e=>e.isAlive&&e.isNominated));return h(`Voting phase begins. Nominated: ${e.map((e=>e.nickname)).join(", ")||"None"}`),0===e.length?(h("No players nominated. Proceeding directly to Night Phase."),void L()):1===e.length?(h(`Only ${e[0].nickname} is nominated. Auto-eliminating.`),B(e[0].id,"vote"),void R()):(a.players.forEach((e=>e.votesReceived=0)),a.tieBreakCount=0,void u())}function M(e,t,n=!1){if(e.innerHTML=`<h3>${n?"Tie-Break Vote":"Vote"}</h3>`,0===t.length)return void(e.innerHTML+="<p>Error: No nominated players for vote.</p>");const i=document.createElement("form");i.id=n?"tie-break-vote-form":"vote-form",t.forEach((e=>{const t=document.createElement("div");t.classList.add("form-group");const n=document.createElement("label");n.htmlFor=`votes-${e.id}`,n.textContent=`Votes for ${e.nickname} (#${e.id}):`;const a=document.createElement("input");a.type="number",a.id=`votes-${e.id}`,a.name=`votes-${e.id}`,a.min="0",a.required=!0,a.dataset.playerId=e.id,t.appendChild(n),t.appendChild(a),i.appendChild(t)}));const o=document.createElement("button");o.type="submit",o.textContent="Submit Votes",i.appendChild(o),i.onsubmit=e=>{e.preventDefault(),function(e){const t=e?"tie-break-vote-form":"vote-form",n=document.getElementById(t);if(!n)return;const i=n.querySelectorAll('input[type="number"]');let o=0,r=[];i.forEach((e=>{const t=parseInt(e.dataset.playerId,10),n=parseInt(e.value,10),i=a.players.find((e=>e.id===t));i&&!isNaN(n)&&n>=0?(i.votesReceived=n,r.push({playerId:t,votes:n}),o+=n):console.warn(`Invalid vote input for player ${t}`)}));const l=a.players.filter((e=>e.isAlive)).length;if(o>l)return void alert(`Error: Total votes (${o}) exceed the number of living players (${l}). Please re-enter votes.`);h(`Votes cast (${o} total): ${r.map((e=>`${a.players.find((t=>t.id===e.playerId)).nickname}: ${e.votes}`)).join(", ")}`);let c=-1;r.forEach((e=>{e.votes>c&&(c=e.votes)}));const s=r.filter((e=>e.votes===c));if(1===s.length){const e=a.players.find((e=>e.id===s[0].playerId));h(`${e.nickname} received the most votes (${c}) and is eliminated.`),B(e.id,"vote"),R()}else s.length>1?function(e){if(h(`Tie in votes between ${e.map((e=>a.players.find((t=>t.id===e)).nickname)).join(" and ")}.`),a.tieBreakCount=(a.tieBreakCount||0)+1,a.tieBreakCount>=2)h("Persistent tie. Admin must decide."),function(e){document.getElementById("game-controls").innerHTML=`\n            <h3>Persistent Tie - Admin Decision</h3>\n            <p>Players tied: ${e.map((e=>a.players.find((t=>t.id===e)).nickname)).join(", ")}</p>\n            <button id="admin-eliminate-all">Eliminate All Tied</button>\n            <button id="admin-keep-all">Keep All Tied (Proceed to Night)</button>\n         `,document.getElementById("admin-eliminate-all").onclick=()=>{h(`Admin decided to eliminate all tied players: ${e.map((e=>a.players.find((t=>t.id===e)).nickname)).join(", ")}`),e.forEach((e=>B(e,"admin_tie_decision"))),R()},document.getElementById("admin-keep-all").onclick=()=>{h("Admin decided to keep all tied players."),R()}}(e);else{h("Initiating Tie-Break Vote.");const t=[];a.players.forEach((n=>{e.includes(n.id)?(n.isNominated=!0,n.isAlive&&t.push(n)):n.isNominated=!1})),u(),M(document.getElementById("game-controls"),t,!0)}}(s.map((e=>e.playerId))):(h("No player received the maximum votes (or votes were 0). Proceeding to Night Phase."),R())}(n)},e.appendChild(i)}function B(e,t){const n=a.players.find((t=>t.id===e));n&&n.isAlive?(n.isAlive=!1,n.eliminationReason=t,n.eliminationDay=a.dayNumber,h(`Player ${n.nickname} (Role: ${n.roleName}, Team: ${n.team}) has been eliminated (${t}).`),"vote"!==t&&"admin_tie_decision"!==t||a.eliminatedByVoteToday.includes(e)||a.eliminatedByVoteToday.push(e),function(e){const t=a.players.find((t=>t.id===e)),n=a.players.find((e=>"krasotka"===e.role&&e.isAlive));n&&n.krasotkaLink===e&&(h(`Krasotka (${n.nickname}) was linked to the eliminated player ${t.nickname} and also dies.`),B(n.id,"krasotka_link"));if(t&&"krasotka"===t.role&&t.krasotkaLink){const e=a.players.find((e=>e.id===t.krasotkaLink));e&&e.isAlive&&(h(`Krasotka (${t.nickname}) died, eliminating their linked partner ${e.nickname}.`),B(e.id,"krasotka_link"))}}(e),O()):console.warn(`Attempted to eliminate non-existent or already dead player ${e}`)}function R(){a.currentPhase="PostVoteReport",h("Voting concluded. Showing elimination results."),w(),u()}function w(){const e=document.getElementById("game-controls");if(e.innerHTML=`<h3>Day ${a.dayNumber} - Voting Results</h3>`,a.eliminatedByVoteToday.length>0){e.innerHTML+="<p>Eliminated by vote:</p><ul>";a.nominationOrder.filter((e=>a.eliminatedByVoteToday.includes(e))).map((e=>a.players.find((t=>t.id===e)))).forEach((t=>{t&&(e.innerHTML+=`<li>${t.nickname} (#${t.id}) - Role: ${t.roleName}</li>`)})),e.innerHTML+="</ul>"}else e.innerHTML+="<p>No players were eliminated by vote.</p>";const t=document.createElement("button");t.id="start-night-button",t.textContent="Start Night Phase",t.onclick=L,e.appendChild(t)}function L(){a.currentPhase="Night",h(`Night ${a.dayNumber} begins. Roles with night actions will proceed.`),a.players.forEach((e=>{e.protectedBy=null,e.killedBy=null,e.donCheckResult=null,e.komissarCheckResult=null,e.zhurnalistCheckResult=null,e.nightActionCompleted=!1,e.krasotkaNightlyChoice=null})),a.nightActionQueue=function(){const e=["mafia","don","komissar","oboroten","doctor","krasotka","zhurnalist","maniac"];let t=[];const i=a.players;return e.forEach((e=>{if("mafia"===e){if(i.some((e=>"Black"===e.team))){const e=i.some((e=>"Black"===e.team&&e.isAlive));t.push({roleKey:"mafia",promptText:x("mafia",null),isAlive:e})}}else{const a=i.find((t=>t.role===e));a&&n[e]?.nightAction&&t.push({playerId:a.id,roleKey:e,nickname:a.nickname,promptText:x(e,a),isAlive:a.isAlive})}})),console.log("Night Action Queue (incl. dead player turns):",t),t}(),a.currentNightActionIndex=-1,u(),P()}function x(e,t){switch(e){case"oboroten":return`${t?.nickname} (Oboroten), choose a target to switch (optional). Current: ${t?.oborotenTargets.join(", ")}.`;case"doctor":return`${t?.nickname} (Doctor), choose a player to protect.`;case"krasotka":return`${t?.nickname} (Krasotka), choose player to protect/link with tonight. If you die, they die too. If they are targeted, they are safe.`;case"don":return`${t?.nickname} (Don), choose a player to check for Komissar.`;case"komissar":return`${t?.nickname} (Komissar), choose a player to check their team.`;case"zhurnalist":return`${t?.nickname} (Zhurnalist), choose two players to check if they are on the same team.`;case"mafia":return"Mafia team, choose a player to eliminate.";case"maniac":return`${t?.nickname} (Maniac), choose a player to eliminate.`;default:return`Unknown action for ${e}`}}function P(){if(a.currentNightActionIndex++,a.currentNightActionIndex>=a.nightActionQueue.length)return void function(){h("Resolving night actions...");let e={eliminations:[],checks:[],protections:[],other:[]},t=[];const n=a.mafiaKillTarget,o=a.players.filter((e=>"maniac"===e.killedBy)).map((e=>e.id));if(n){const i=a.players.find((e=>e.id===n)),o=a.players.find((e=>"krasotka"===e.role&&e.isAlive));if(i&&i.isAlive)if(o&&o.krasotkaNightlyChoice===i.id)h(`Mafia attempted to kill ${i.nickname}, but they were protected by Krasotka!`),e.protections.push(`Krasotka saved ${i.nickname} from Mafia.`);else if("doctor"===i.protectedBy)h(`Mafia attempted to kill ${i.nickname}, but they were saved by the Doctor!`),e.protections.push(`Doctor saved ${i.nickname} from Mafia.`);else if(h(`Mafia successfully killed ${i.nickname}.`),"krasotka"===i.role&&null!==i.krasotkaNightlyChoice){const e=i.krasotkaNightlyChoice,n=a.players.find((t=>t.id===e));h(`Mafia killed Krasotka (${i.nickname})!`),B(i.id,"mafia"),t.push({id:i.id,nickname:i.nickname,by:"Mafia (Killed Krasotka)"}),n&&n.isAlive&&(h(`...and also killed ${n.nickname} due to the nightly link!`),B(n.id,"krasotka_link"),t.push({id:n.id,nickname:n.nickname,by:"Krasotka Link (Mafia Kill)"}))}else B(i.id,"mafia"),t.push({id:i.id,nickname:i.nickname,by:"Mafia"});else h(`Mafia targeted ${i?i.nickname:`Player ${n}`}, but they were already dead or invalid.`)}a.mafiaKillTarget=null,o.forEach((n=>{const i=a.players.find((e=>e.id===n)),o=(a.players.find((e=>"maniac"===e.killedBy&&e.id===n)),a.players.find((e=>"maniac"===e.role&&e.isAlive))),r=a.players.find((e=>"krasotka"===e.role&&e.isAlive));if(i&&i.isAlive)if(r&&r.krasotkaNightlyChoice===i.id)h(`Maniac attempted to kill ${i.nickname}, but they were protected by Krasotka!`),e.protections.push(`Krasotka saved ${i.nickname} from Maniac.`);else if("doctor"===i.protectedBy)h(`Maniac (${o?.nickname}) attempted to kill ${i.nickname}, but they were saved by the Doctor!`),e.protections.push(`Doctor saved ${i.nickname} from Maniac.`);else if(h(`Maniac (${o?.nickname}) successfully killed ${i.nickname}.`),"krasotka"===i.role&&null!==i.krasotkaNightlyChoice){const e=i.krasotkaNightlyChoice,n=a.players.find((t=>t.id===e));h(`Maniac killed Krasotka (${i.nickname})!`),B(i.id,"maniac"),t.push({id:i.id,nickname:i.nickname,by:"Maniac (Killed Krasotka)"}),n&&n.isAlive&&(h(`...and also killed ${n.nickname} due to the nightly link!`),B(n.id,"krasotka_link"),t.push({id:n.id,nickname:n.nickname,by:"Krasotka Link (Maniac Kill)"}))}else B(i.id,"maniac"),t.push({id:i.id,nickname:i.nickname,by:"Maniac"});else i&&!i.isAlive?h(`Maniac (${o?.nickname}) targeted ${i.nickname}, but they were already eliminated.`):h(`Maniac (${o?.nickname}) targeted Player ${n}, but they were invalid or already dead.`)}));const r=a.players.find((e=>"oboroten"===e.role&&e.isAlive));r&&r.oborotenTargets.forEach((n=>{const i=a.players.find((e=>e.id===n));!i||i.isAlive||t.some((e=>e.id===n))?t.some((e=>e.id===n))&&(h(`Oboroten's target ${i.nickname} was eliminated this night!`),e.other.push(`Oboroten target ${i.nickname} eliminated.`)):(h(`Oboroten's target ${i.nickname} was already dead.`),e.other.push(`Oboroten target ${i.nickname} was already dead.`))}));a.players.forEach((t=>{if(t.isAlive){if(t.donCheckResult){const n=t.donCheckResult;e.checks.push(`Don (${t.nickname}) checked ${n.targetNickname}: ${n.isKomissar?"IS Komissar":"NOT Komissar"}.`)}if(t.komissarCheckResult){const n=t.komissarCheckResult;e.checks.push(`Komissar (${t.nickname}) checked ${n.targetNickname}: Team is ${n.targetTeam}.`)}if(t.zhurnalistCheckResult){const n=t.zhurnalistCheckResult;e.checks.push(`Zhurnalist (${t.nickname}) checked ${n.targetNickname1} and ${n.targetNickname2}: ${n.sameTeam?"SAME Team":"DIFFERENT Teams"}.`)}}})),e.eliminations=t,a.lastNightReport=e,console.log("Night Report:",e),a.currentPhase="Report",h(`Night ${a.dayNumber} ended. Displaying report.`),function(){const e=document.getElementById("report-screen");e.innerHTML=`<h2>Night ${a.dayNumber} Report</h2>`;const t=a.lastNightReport||{eliminations:[],checks:[],protections:[],other:[]};if(e.innerHTML+="<h3>Eliminations:</h3>",t.eliminations.length>0){const n=document.createElement("ul");t.eliminations.forEach((e=>{const t=a.players.find((t=>t.id===e.id));n.innerHTML+=`<li>${e.nickname} (Role: ${t?.roleName}, Team: ${t?.team}) killed by ${e.by}.</li>`})),e.appendChild(n)}else e.innerHTML+="<p>No one was eliminated.</p>";if(e.innerHTML+="<h3>Protections:</h3>",t.protections.length>0){const n=document.createElement("ul");t.protections.forEach((e=>n.innerHTML+=`<li>${e}</li>`)),e.appendChild(n)}else e.innerHTML+="<p>No protections were noted (or needed).</p>";if(e.innerHTML+="<h3>Checks:</h3>",t.checks.length>0){const n=document.createElement("ul");t.checks.forEach((e=>n.innerHTML+=`<li>${e}</li>`)),e.appendChild(n)}else e.innerHTML+="<p>No checks were performed or reported.</p>";if(e.innerHTML+="<h3>Other Events:</h3>",t.other.length>0){const n=document.createElement("ul");t.other.forEach((e=>n.innerHTML+=`<li>${e}</li>`)),e.appendChild(n)}else e.innerHTML+="<p>No other significant events.</p>";const n=document.createElement("button");n.id="next-day",n.textContent=`Start Day ${a.dayNumber+1}`,n.onclick=()=>{O(!0)?console.log("Game already won, cannot start next day."):(a.dayNumber++,T(),i("game"))},e.appendChild(n),u()}(),i("report")}();const e=a.nightActionQueue[a.currentNightActionIndex];!function(e,t){const n=t.roleKey.charAt(0).toUpperCase()+t.roleKey.slice(1);e.innerHTML=`<h3>Night ${a.dayNumber} - ${n} Action</h3>`,e.innerHTML+=`<p>${t.promptText}</p>`;const i=document.createElement("form");if(i.id="night-action-form",t.isAlive){!function(e,t,n){const i=a.players.filter((e=>e.isAlive)),o=a.players.find((e=>e.id===n));switch(t){case"doctor":case"don":case"komissar":case"maniac":case"mafia":const r=document.createElement("label");r.textContent="Target: ";const l=document.createElement("select");l.id="night-target",l.required=!0,l.add(new Option("--Select Player--","",!0,!0)),i.forEach((e=>{let a=!0;"doctor"===t&&e.id===n&&(a=!1),a&&l.add(new Option(`${e.nickname} (#${e.id})`,e.id))})),r.appendChild(l),e.appendChild(r);break;case"krasotka":const c=document.createElement("label");c.textContent="Protect/Link tonight: ";const s=document.createElement("select");s.id="night-target",s.add(new Option("-- No One --","null")),i.forEach((e=>{e.id!==n&&s.add(new Option(`${e.nickname} (#${e.id})`,e.id))})),c.appendChild(s),e.appendChild(c);break;case"zhurnalist":const d=document.createElement("label");d.textContent="Player 1: ";const m=document.createElement("select");m.id="night-target1",m.required=!0,m.add(new Option("--Select Player 1--","",!0,!0)),i.forEach((e=>{m.add(new Option(`${e.nickname} (#${e.id})`,e.id))})),d.appendChild(m),e.appendChild(d),e.appendChild(document.createElement("br"));const u=document.createElement("label");u.textContent="Player 2: ";const p=document.createElement("select");p.id="night-target2",p.required=!0,p.add(new Option("--Select Player 2--","",!0,!0)),i.forEach((e=>{p.add(new Option(`${e.nickname} (#${e.id})`,e.id))})),u.appendChild(p),e.appendChild(u);break;case"oboroten":const h=o?o.oborotenTargets:[];e.innerHTML+=`<p>Current Targets: ${h.map((e=>a.players.find((t=>t.id===e))?.nickname||`ID ${e}`)).join(" and ")}</p>`;const y=document.createElement("label");y.textContent="Target to remove: ";const k=document.createElement("select");k.id="night-target-remove",k.add(new Option("--Keep Current--","",!0,!0)),h.forEach((e=>{const t=a.players.find((t=>t.id===e));t&&k.add(new Option(`${t.nickname} (#${e})`,e))})),y.appendChild(k),e.appendChild(y),e.appendChild(document.createElement("br"));const g=document.createElement("label");g.textContent="Target to add: ";const f=document.createElement("select");f.id="night-target-add",f.add(new Option("--Select New Target--","",!0,!0)),i.forEach((e=>{e.id===n||h.includes(e.id)||f.add(new Option(`${e.nickname} (#${e.id})`,e.id))})),g.appendChild(f),e.appendChild(g),e.appendChild(document.createElement("p")).textContent="(Select both to switch, or leave blank/default to keep current targets)";break;default:e.innerHTML+="<p>Action input not implemented yet.</p>"}}(i,t.roleKey,t.playerId);const e=document.createElement("button");e.type="submit",e.textContent="Submit Action",i.appendChild(e);const n=document.createElement("button");n.type="button",n.textContent="Skip Action",n.onclick=()=>{h(`${t.nickname||"Mafia"} skipped their night action.`),P()},i.appendChild(n),i.onsubmit=e=>{e.preventDefault(),function(e,t){const n=document.getElementById("night-action-form");if(!n)return;const i=a.players.find((e=>e.id===t));let o=null,r=null,l=null,c=null,s=null,d=null;if(["doctor","don","komissar","maniac","mafia","krasotka"].includes(e)){const t=n.querySelector("#night-target");if(t&&t.value)o="null"===t.value?null:parseInt(t.value,10),c=o?a.players.find((e=>e.id===o)):null;else{if("krasotka"!==e)return void alert("Please select a target player.");o=null,c=null}}else if("zhurnalist"===e){const e=n.querySelector("#night-target1"),t=n.querySelector("#night-target2");if(!(e&&e.value&&t&&t.value))return void alert("Please select two target players.");if(r=parseInt(e.value,10),l=parseInt(t.value,10),r===l)return void alert("Please select two different players.");s=a.players.find((e=>e.id===r)),d=a.players.find((e=>e.id===l))}else if("oboroten"===e){const e=n.querySelector("#night-target-remove"),t=n.querySelector("#night-target-add"),a=e&&e.value?parseInt(e.value,10):null,o=t&&t.value?parseInt(t.value,10):null;if(!a||!o)return a||o?void alert("To switch Oboroten targets, you must select both a target to remove AND a target to add."):(h(`${i.nickname} (Oboroten) did not switch targets.`),i.nightActionCompleted=!0,void P());r=a,l=o}let m="";switch(e){case"doctor":c&&(c.protectedBy="doctor",m=`Doctor (${i.nickname}) chose to protect ${c.nickname}.`);break;case"krasotka":i?(i.krasotkaNightlyChoice=o,m=c?`Krasotka (${i.nickname}) chose to protect ${c.nickname} tonight.`:`Krasotka (${i.nickname}) chose to protect no one tonight.`):m="Error: Krasotka player not found for action submission.";break;case"don":c&&(i.donCheckResult={targetId:o,targetNickname:c.nickname,isKomissar:"komissar"===c.role},m=`Don (${i.nickname}) checked ${c.nickname}.`);break;case"komissar":c&&(i.komissarCheckResult={targetId:o,targetNickname:c.nickname,targetTeam:c.team},m=`Komissar (${i.nickname}) checked ${c.nickname}.`);break;case"zhurnalist":s&&d&&(i.zhurnalistCheckResult={targetId1:r,targetNickname1:s.nickname,targetId2:l,targetNickname2:d.nickname,sameTeam:s.team===d.team},m=`Zhurnalist (${i.nickname}) checked ${s.nickname} and ${d.nickname}.`);break;case"mafia":c&&(a.mafiaKillTarget=o,m=`Mafia chose to target ${c.nickname}.`);break;case"maniac":c&&(c.killedBy="maniac",m=`Maniac (${i.nickname}) targeted ${c.nickname}.`);break;case"oboroten":if(i&&r&&l){const e=i.oborotenTargets.indexOf(r);e>-1&&i.oborotenTargets.splice(e,1),i.oborotenTargets.push(l),m=`Oboroten (${i.nickname}) switched target from #${r} to #${l}. New targets: ${i.oborotenTargets.join(", ")}.`}}m&&h(m);i?i.nightActionCompleted=!0:"mafia"===e&&a.players.forEach((e=>{"mafia"===e.role&&e.isAlive&&(e.nightActionCompleted=!0)}));P()}(t.roleKey,t.playerId)}}else{i.innerHTML+=`<p><i>(${"mafia"===t.roleKey?"No Mafia members left":`${t.nickname} is eliminated`})</i></p>`;const e=document.createElement("button");e.type="button",e.textContent="Next Action",e.onclick=()=>{P()},i.appendChild(e)}e.appendChild(i)}(document.getElementById("game-controls"),e)}function O(e=!1){const t=a.players.filter((e=>e.isAlive)),n=t.length;if(0===n)return K("Draw","All players were eliminated simultaneously."),!0;const i=t.filter((e=>"Red"===e.team)).length,o=t.filter((e=>"Black"===e.team)).length,r=t.filter((e=>"Independent"===e.team)).length,l=t.find((e=>"maniac"===e.role)),c=t.find((e=>"oboroten"===e.role));if(r>0&&l&&1===n&&l)return K("Maniac",`${l.nickname} is the last one standing.`),!0;if(c){const e=c.oborotenTargets,t=a.players.find((t=>t.id===e[0])),n=a.players.find((t=>t.id===e[1]));2===e.length&&t&&!t.isAlive&&n&&n.isAlive}if(o>0&&o>=i+r)return K("Black Team (Mafia)",`Mafia (${o}) equal or outnumber others (${i+r}).`),!0;if(0===o&&0===r){if(i>0)return K("Red Team (Citizens)","All Mafia and Independents have been eliminated."),!0;console.warn("Win check: Red team wins condition met, but red count is 0?")}return e||console.log("No win condition met yet."),!1}function K(e,t){h(`GAME OVER! Winner: ${e}. Reason: ${t}`),alert(`GAME OVER!\nWinner: ${e}\nReason: ${t}`);const n=document.getElementById("game-controls");n&&(n.innerHTML=`<h2>Game Over! Winner: ${e}</h2><p>${t}</p><button onclick="window.location.reload()">New Game</button>`);const a=document.getElementById("timer-controls");a&&(a.innerHTML="");const i=document.getElementById("next-day");i&&(i.textContent="New Game",i.onclick=()=>window.location.reload())}}))</script></body></html>